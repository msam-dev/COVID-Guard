const bcrypt = require('bcryptjs');
const config = require('config');
const jwt = require("jsonwebtoken");
const JWT_SECRET = config.get('JWT_SECRET');
const $ = require('cheerio');
const sgMail = require('@sendgrid/mail');

const d31 = require("d3-geo");
const d32 = require("d3-random");

function convertToNumber(str) {
    return Number(str.replace(/,/g, ''))
}

function generate5CharacterCode(){
    return getRandomInt(1679616, 60466176).toString(36).toUpperCase()
}

function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
}

function encryptPassword(password)
{
    const salt = bcrypt.genSaltSync(10);
    if (!salt) throw Error('Something went wrong with bcrypt');

    const hash = bcrypt.hashSync(password, salt);
    if (!hash) throw Error('Something went wrong hashing the password');
    return hash;
}

function createAuthToken(userId, userType){
    return jwt.sign({ userId, userType }, JWT_SECRET, { expiresIn: 60*60*24 });
}

function dailySummary(html, category){
    let cat = matchText($(html).find('table.DAILY-SUMMARY td.CATEGORY a'), category).parent().parent();
    return {
        total: () => {return convertToNumber(cat.find("td.TOTAL").text())},
        net: () => {return convertToNumber(cat.find("td.NET").text())}
    };
}

function matchText(selector, text){
    return selector.filter(function() {
        return $(this).text().trim() === text;
    });
}

class Emailer {
    static async sendEmail(msg, dont_send=false) {
        if(dont_send){
            return [{statusCode: 202}];
        }
        // override email at the moment because using test data
        msg["to"] = process.env.SENDGRID_TO_EMAIL;
        console.log(`Message sent to: ${msg["to"]}`);
        sgMail.setApiKey(process.env.SENDGRID_API_KEY)
        return await sgMail.send(msg);
    }
}

const australia = JSON.parse('{"type":"Feature","id":"036","properties":{"name":"Australia"},"geometry":{"type":"MultiPolygon","coordinates":[[[[147.68967689676896,-40.808704103002725],[148.2872828728287,-40.874713888532675],[148.35928359283594,-42.06289002807174],[148.01728017280175,-42.406479424548145],[147.9128791287913,-43.21213731973418],[147.5636756367564,-42.93794282599439],[146.86886868868692,-43.63527697056718],[146.6636666366664,-43.58111509526056],[146.04806048060482,-43.54895648179725],[145.43245432454324,-42.694214387114584],[145.29565295652958,-42.0341165318151],[144.71964719647195,-41.162448851099114],[144.7448474484745,-40.70376546959614],[145.39645396453966,-40.7917785169694],[146.36486364863651,-41.137060472049136],[146.90846908469086,-40.99996322517924],[147.68967689676896,-40.808704103002725]]],[[[126.14706147061474,-32.215584073886106],[125.0886508865089,-32.728429330695704],[124.22104221042213,-32.96030985935219],[124.03024030240306,-33.483310467781784],[123.65943659436596,-33.88952453258147],[122.809828098281,-33.91491291163145],[122.18342183421834,-34.00292595900471],[121.2978129781298,-33.82182218844819],[120.58140581405814,-33.93014593906143],[119.8937989379894,-33.9758450213514],[119.29979299793001,-34.50900098140098],[119.0081900819008,-34.46499445771435],[118.5041850418504,-34.747651744470794],[118.02538025380255,-35.06416020329388],[117.29457294572944,-35.02523135541725],[116.62496624966252,-35.02523135541725],[115.56295562955631,-34.387136761961074],[115.02655026550269,-34.19587763978456],[115.04815048150482,-33.62379283185834],[115.5449554495545,-33.486695584988446],[115.71415714157143,-33.25989273214196],[115.67815678156785,-32.901070308235575],[115.80055800558006,-32.20542872226611],[115.68895688956889,-31.61303321109991],[115.15975159751599,-30.60088316630737],[114.99774997749978,-30.030490916984483],[115.04095040950409,-29.46179122626493],[114.64134641346413,-28.8101561639821],[114.61614616146164,-28.51565096700233],[114.17334173341732,-28.117899695219307],[114.04734047340474,-27.334245061876587],[113.47853478534785,-26.543820194120542],[113.33813338133382,-26.117295426080872],[113.77733777337772,-26.548897869930535],[113.44253442534426,-25.62137575530459],[113.93573935739357,-25.91080327647437],[114.23454234542345,-26.298399196637398],[114.21654216542169,-25.7855539398278],[113.71973719737201,-24.998514189278417],[113.6261362613626,-24.68369828905866],[113.39213392133922,-24.38411541626889],[113.5037350373504,-23.80695293253268],[113.70533705337056,-23.559839376446206],[113.84213842138422,-23.060534588463263],[113.73773737737378,-22.474909311710384],[114.14814148141483,-21.755571905294282],[114.22374223742236,-22.517223276793686],[114.64854648546486,-21.830044483840894],[115.45855458554587,-21.494917880381152],[115.94815948159481,-21.068393112341482],[116.71136711367114,-20.701107895418446],[117.1649716497165,-20.623250199665165],[117.44217442174426,-20.746806977708403],[118.23058230582308,-20.374444084975366],[118.83538835388356,-20.262735217155452],[118.98658986589868,-20.044395157325624],[119.25299252992534,-19.952996992745696],[119.80379803798041,-19.976692813192344],[120.85500855008553,-19.683880174815897],[121.39861398613988,-19.240429820742918],[121.65421654216544,-18.705581302089996],[122.2410224102241,-18.197813721090398],[122.28782287822878,-17.798369890704038],[122.31302313023133,-17.25505857903447],[123.01143011430116,-16.40539416016179],[123.43263432634325,-17.268599047861116],[123.86103861038612,-17.06887713266795],[123.50463504635047,-16.59665328233831],[123.8178381783818,-16.11088896318202],[124.25704257042571,-16.327536464408524],[124.37944379443798,-15.567577651512451],[124.92664926649269,-15.075043097942839],[125.1678516785168,-14.680676943366478],[125.6718567185672,-14.509728524429946],[125.68625686256865,-14.230456354880161],[126.12546125461256,-14.347242898510075],[126.14346143461438,-14.096744225216938],[126.58266582665829,-13.952876743933714],[127.0650706507065,-13.817472055667153],[127.80307803078034,-14.276155437170132],[128.36108361083615,-14.868550948336335],[128.9838898388984,-14.875321182749659],[129.6210962109621,-14.970104464536249],[129.4086940869409,-14.420022918453355],[129.88749887498875,-13.619442699077311],[130.3411034110341,-13.35709611556085],[130.18270182701826,-13.108290000871037],[130.61830618306186,-12.53620519294482],[131.22311223112234,-12.184153003451769],[131.73431734317342,-12.302632105685007],[132.5767257672577,-12.11475810071515],[132.55872558725588,-11.60360540250889],[131.82431824318246,-11.273556474859134],[132.35712357123572,-11.127996434972587],[133.01953019530197,-11.3768025496624],[133.55233552335523,-11.786401731668747],[134.3947439474395,-12.04197808077187],[134.67914679146793,-11.940424564571956],[135.29835298352987,-12.248470230378373],[135.88155881558816,-11.962427826415265],[136.259562595626,-12.048748315185208],[136.49356493564937,-11.85748919300869],[136.9507695076951,-12.351716305181625],[136.68436684366844,-12.886564823834547],[136.30636306363067,-13.291086330030893],[135.96075960759606,-13.32493750209754],[136.0759607596076,-13.724381332483887],[135.78435784357845,-14.223686120466837],[135.4279542795428,-14.71622067403645],[135.49995499955003,-14.997185402189558],[136.29556295562958,-15.550652065479127],[137.06597065970664,-15.870545641508883],[137.58077580775807,-16.21582759658861],[138.30438304383046,-16.808223107754813],[138.5851858518585,-16.80653054915149],[139.10719107191073,-17.062106898254612],[139.26199261992622,-17.371845122664368],[140.21600216002162,-17.71035684333077],[140.8748087480875,-17.368460005457706],[141.0728107281073,-16.83191892820146],[141.27441274412746,-16.38846857412848],[141.39681396813967,-15.840079586648912],[141.70281702817027,-15.044577043082867],[141.56241562415624,-14.560505282529903],[141.63441634416347,-14.271077761360132],[141.51921519215193,-13.697300394830577],[141.65241652416523,-12.944111816347842],[141.84321843218436,-12.741004783948],[141.68841688416887,-12.407570739091582],[141.92961929619298,-11.877799896248675],[142.1168211682117,-11.327718350165767],[142.14202142021423,-11.043368504805983],[142.51642516425164,-10.667620494866284],[142.79722797227976,-11.156769931229235],[142.86562865628656,-11.784709173065409],[143.11763117631176,-11.904880833901984],[143.1572315723157,-12.326327926131654],[143.52083520835208,-12.834095507131252],[143.59643596435967,-13.401102639247483],[143.56043560435603,-13.763310180360534],[143.92043920439204,-14.548657372306579],[144.56484564845647,-14.171216803763542],[144.89604896048962,-14.59435645459655],[145.37485374853748,-14.985337491966234],[145.27045270452703,-15.428787846039228],[145.48645486454865,-16.28522249932523],[145.63765637656377,-16.784527287308165],[145.88965889658897,-16.906391506748065],[146.159661596616,-17.761133601430743],[146.06246062460627,-18.280749092653664],[146.38646386463864,-18.95777253398647],[147.47007470074703,-19.480773142416055],[148.17928179281796,-19.956382109952358],[148.84888848888488,-20.391369671008675],[148.71568715687158,-20.633405551285165],[149.28809288092884,-21.26134479312134],[149.6768967689677,-22.34288974065049],[150.07650076500767,-22.122857122217326],[150.48330483304835,-22.556152124670326],[150.72810728107282,-22.40212929176711],[150.90090900909013,-23.461670977452947],[151.610116101161,-24.076069750462466],[152.07452074520745,-24.458587994815502],[152.8557285572856,-25.2676310072082],[153.13653136531366,-26.071596343790908],[153.1617316173162,-26.641988593113794],[153.09333093330935,-27.259772483329982],[153.5685356853569,-28.109436902202653],[153.51093510935112,-28.994645051745287],[153.33813338133382,-29.45840610905826],[153.0681306813068,-30.350384493014232],[153.08973089730898,-30.92416185954378],[152.89172891728919,-31.64011414875322],[152.44892448924492,-32.55071067734585],[151.71091710917108,-33.04155267231213],[151.3437134371344,-33.81674451263819],[151.00891008910088,-34.31097162481114],[150.71370713707137,-35.17417651251046],[150.32850328503287,-35.67178874189007],[150.07650076500767,-36.41989964456282],[149.94689946899473,-37.10877099611895],[149.99729997299977,-37.425279454942036],[149.4248942489425,-37.772253968625094],[148.30528305283053,-37.8094902578984],[147.38007380073805,-38.21908943990475],[146.92286922869232,-38.60668536006778],[146.31806318063184,-39.03659524531411],[145.490054900549,-38.593144891241124],[144.8780487804878,-38.41711879649459],[145.0328503285033,-37.89581074666833],[144.48564485644857,-38.08537731024152],[143.61083610836107,-38.80979239246762],[142.74682746827472,-38.5389830159345],[142.17802178021782,-38.37988250722129],[141.60561605616056,-38.30879504588135],[140.63720637206376,-38.01936752471157],[139.99279992799927,-37.40327619309872],[139.80559805598057,-36.643317380202646],[139.57519575195755,-36.13893491640971],[139.08199081990819,-35.732720851610026],[138.12078120781212,-35.61254919077345],[138.44838448384485,-35.12678487161716],[138.20718207182074,-34.38544420335774],[137.7175771757718,-35.076008113517204],[136.82836828368283,-35.26049700128039],[137.35397353973542,-34.70703033799083],[137.50517505175054,-34.12986785425461],[137.89037890378904,-33.64071841789166],[137.81117811178115,-32.89937774963224],[136.99756997569978,-33.75242728571157],[136.3711637116371,-34.09432412358464],[135.98955989559897,-34.889826667150686],[135.20835208352082,-34.478534926541],[135.2407524075241,-33.94876408369809],[134.61434614346143,-33.222656442868654],[134.08514085140854,-32.84860099153228],[134.27234272342724,-32.61672046287579],[132.9907299072991,-32.01078448288293],[132.28872288722886,-31.982010986626292],[131.3275132751328,-31.496246667470004],[129.53469534695347,-31.591029949256594],[128.24228242282425,-31.948159814559652],[127.10107101071014,-32.281593859416056],[126.14706147061474,-32.215584073886106]]]]}}')

// https://observablehq.com/@jeffreymorganio/random-coordinates-within-a-country
function randomBoundingBoxCoordinates(boundingBox) {
    const randomLongitude = d32.randomUniform(
        boundingBox[0][0],
        boundingBox[1][0] + 360 * (boundingBox[1][0] < boundingBox[0][0])
    )
    const randomLatitude = d32.randomUniform(boundingBox[0][1], boundingBox[1][1])
    return () => [randomLongitude(), randomLatitude()]
}

// https://observablehq.com/@jeffreymorganio/random-coordinates-within-a-country
function randomFeatureCoordinates(feature) {
    const featureBoundingBox = d31.geoBounds(feature)
    const randomCoordinates = randomBoundingBoxCoordinates(featureBoundingBox)
    return () => {
        let p
        do {
            p = randomCoordinates()
        } while (!d31.geoContains(feature, p))
        return p
    }
}

randomAustraliaCoordinates = randomFeatureCoordinates(australia);

function random_coordinate(){
    return randomAustraliaCoordinates();
}
module.exports = {random_coordinate, Emailer, convertToNumber, generate5CharacterCode, encryptPassword, createAuthToken, dailySummary, matchText};